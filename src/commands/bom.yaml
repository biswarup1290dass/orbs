description: Create SBOM for target
parameters:
  target:
    description: Target object name format=[docker:{image:tag}, dir:{dir_path}, git:{git_path}, docker-archive:{archive_path}, oci-archive:archive_path, registry:image:tag]
    default: ""
    type: string
  components:
    description: Select sbom components groups, options=[metadata layers packages syft files dep commits]
    default: metadata,layers,packages,files,dep
    type: string
  config:
    description: Application config file
    default: ""
    type: string
  context-dir:
    description: Context dir
    default: ""
    type: string
  env:
    description: Envrionment keys to include in sbom
    default: ""
    type: string
  product-key:
    description: 'Custom/project product-key'
    default: ""
    type: string
  filter-purl:
    description: Filter out purls by regex
    default: ""
    type: string
  filter-regex:
    description: Filter out files by regex
    default: ""
    type: string
  filter-scope:
    description: 'Filter packages by scope'
    default: ""
    type: string
  package-type:
    description: 'Select package type'
    default: ""
    type: string
  package-group:
    description: 'Select package group'
    default: ""
    type: string
  attach-regex:
    description: Attach files content by regex
    default: ""
    type: string
  force:
    description: Force overwrite cache
    default: false
    type: boolean
  format:
    description: Evidence format, options=[cyclonedx-json cyclonedx-xml attest-cyclonedx-json statement-cyclonedx-json predicate-cyclonedx-json attest-slsa statement-slsa predicate-slsa]
    default: cyclonedx-json
    type: string
  label:
    description: Label to connect to sboms
    default: ""
    type: string
  output-directory:
    description: Report output directory
    default: ./scribe/valint
    type: string
  output-file:
    description: Output result to file
    default: ""
    type: string
  verbose:
    description: Log verbosity level [-v,--verbose=1] = info, [-vv,--verbose=2] = debug
    default: 1
    type: integer
  attest-config:
    description: 'Attestation config map'
    default: ""
    type: string
  attest-default:
    description: 'Attestation default config, options=[sigstore sigstore-github x509]'
    default: ""
    type: string
  scribe-enable:
    description: 'Enable scribe client'
    default: false
    type: boolean
  scribe-client-id:
    description: 'Scribe client id'
    type: string
    default: ""
  scribe-client-secret:
    description: 'Scribe access token'
    type: string
    default: ""
  scribe-url:
    description: 'Scribe url'
    type: string
    default: ""
  scribe-login-url:
    description: 'Scribe auth login url'
    type: string
    default: ""
  scribe-audience:
    description: 'Scribe auth audience'
    type: string
    default: ""
  oci:
    description: 'Enable OCI store'
    default: false
    type: boolean
  oci-repo:
    description: 'Select OCI custom attestation repo'
    type: string
    default: ""

steps:
- run:
    name: Create SBOM for target
    command: >
        valint bom << parameters.target >> \
          <<# parameters.product-key >>--product-key << parameters.product-key >><</ parameters.product-key >> \
          <<# parameters.attach-regex >>--attach-regex << parameters.attach-regex >><</ parameters.attach-regex >> \
          <<# parameters.components >>--components << parameters.components >><</ parameters.components >> \
          <<# parameters.context-dir >>--context-dir << parameters.context-dir >><</ parameters.context-dir >> \
          <<# parameters.env >>--env << parameters.env >><</ parameters.env >> \
          <<# parameters.force >>--force << parameters.force >><</ parameters.force >> \
          <<# parameters.format >>--format << parameters.format >><</ parameters.format >> \
          <<# parameters.label >>--label << parameters.label >><</ parameters.label >> \
          <<# parameters.config >>--config << parameters.config >><</ parameters.config >> \
          <<# parameters.filter-purl >>--filter-purl << parameters.filter-purl >><</ parameters.filter-purl >> \
          <<# parameters.filter-regex >>--filter-regex << parameters.filter-regex >><</ parameters.filter-regex >> \
          <<# parameters.filter-scope >>--filter-scope << parameters.filter-scope >><</ parameters.filter-scope >> \
          <<# parameters.package-type >>--package-type << parameters.package-type >><</ parameters.package-type >> \
          <<# parameters.package-group >>--package-group << parameters.package-group >><</ parameters.package-group >> \
          <<# parameters.output-directory >>--output-directory << parameters.output-directory >><</ parameters.output-directory >> \
          <<# parameters.output-file >>--output-file << parameters.output-file >><</ parameters.output-file >> \
          <<# parameters.verbose >>--verbose << parameters.verbose >><</ parameters.verbose >> \
          <<# parameters.attest-config >>--attest.config << parameters.attest-config >><</ parameters.attest-config >> \
          <<# parameters.attest-default >>--attest.default << parameters.attest-default >><</ parameters.attest-default >> \
          <<# parameters.scribe-client-id >>--scribe.client-id << parameters.scribe-client-id >><</ parameters.scribe-client-id  >> \
          <<# parameters.scribe-client-secret >>--scribe.client-secret << parameters.scribe-client-secret >><</ parameters.scribe-client-secret  >> \
          <<# parameters.scribe-enable  >>--scribe.enable << parameters.scribe-enable >><</ parameters.scribe-enable  >> \
          <<# parameters.scribe-url  >>--scribe.url << parameters.scribe-url >><</ parameters.scribe-url  >> \
          <<# parameters.scribe-audience  >>--scribe.auth.audience << parameters.scribe-audience >><</ parameters.scribe-audience  >> \
          <<# parameters.scribe-login-url  >>--scribe.login-url << parameters.scribe-login-url >><</ parameters.scribe-login-url  >> \
          <<# parameters.oci >>--oci << parameters.oci >><</ parameters.oci >> \
          <<# parameters.oci-repo  >>--oci-repo << parameters.oci-repo >><</ parameters.oci-repo  >> \
          --context-type=circleci
