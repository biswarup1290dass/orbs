description: Create SBOM for target
parameters:
  TARGET:
    description: Create SBOM for target
    default: ""
    type: string
  components:
    description: Select sbom components groups, options=[metadata layers packages files dep]
    default: metadata,layers,packages,files,dep
    type: string
  config:
    description: Application config file
    default: ""
    type: string
  context-dir:
    description: Context dir
    default: ""
    type: string
  context-type:
    description: Context type, options=[jenkins github local]
    default: local
    type: string
  env:
    description: Envrionment keys to include in sbom
    default: ""
    type: string
  product-key:
    description: 'Custom/project product-key'
    default: ""
    type: string
  filter-purl:
    description: Filter out purls by regex
    default: ""
    type: string
  filter-regex:
    description: Filter out files by regex
    default: .*\.pyc,.*\.git/.*
    type: string
  attach-regex:
    description: Attach files content by regex
    default: ""
    type: string
  force:
    description: Force overwrite cache
    default: false
    type: boolean
  format:
    description: Sbom formatter, options=[cyclonedx-json cyclonedx-xml attest-cyclonedx-json statement-cyclonedx-json predicate-cyclonedx-json]
    default: cyclonedx-json
    type: string
  label:
    description: Label to connect to sboms
    default: ""
    type: string
  output-directory:
    description: Report output directory
    default: /home/samtholiya/.cache/gensbom
    type: string
  output-file:
    description: Output result to file
    default: ""
    type: string
  verbose:
    description: Increase verbosity (-v = info, -vv = debug)
    default: 1
    type: integer
  attest-config:
    description: 'Attestation config map'
    default: ""
    type: string
  attest-name:
    description: 'Attestation config name (default "gensbom")'
    default: ""
    type: string
  attest-default:
    description: 'Attestation default config, options=[sigstore sigstore-github x509]'
    default: "sigstore"
    type: string
  scribe-enable:
    description: 'Enable scribe client'
    default: false
    type: boolean
  scribe-clientid:
    description: 'Scribe client id'
    type: string
    default: ""
  scribe-clientsecret:
    description: 'Scribe access token'
    type: string
    default: ""
  scribe-url:
    description: 'Scribe url'
    type: string
    default: ""
  scribe-loginurl:
    description: 'Scribe auth login url'
    type: string
    default: ""
  scribe-audience:
    description: 'Scribe auth audience'
    type: string
    default: ""

steps:
- run:
    name: Create SBOM for target
    command: >
        gensbom bom << parameters.TARGET >> \
          <<# parameters.attach-regex >>--attach-regex << parameters.attach-regex >><</ parameters.attach-regex >> \
          --components << parameters.components >> \
          --context-dir << parameters.context-dir >> \
          --context-type << parameters.context-type >> \
          --env << parameters.env >> \
          --force << parameters.force >> \
          --format << parameters.format >> \
          --label << parameters.label >> \
          --config << parameters.config >> \
          --filter-purl << parameters.filter-purl >> \
          --filter-regex << parameters.filter-regex >> \
          --output-directory << parameters.output-directory >> \
          --output-file << parameters.output-file >> \
          --verbose << parameters.verbose >>
          --attest.config << parameters.attest-config >> \
          --attest.name << parameters.attest-name >> \
          --attest.default << parameters.attest-default >> \
          --scribe.clientid << parameters.scribe-clientid >> \
          --scribe.clientsecret << parameters.scribe-clientsecret >> \
          --scribe.enable << parameters.scribe-enable >> \
          --scribe.url << parameters.scribe-url >> \
          --scribe.auth0.audience << parameters.scribe-audience >> \
          --scribe.loginurl << parameters.scribe-loginurl >>
      # --product-key << parameters.product-key >> \
